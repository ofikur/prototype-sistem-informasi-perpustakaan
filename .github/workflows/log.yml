name: System Log Sequence

on:
  schedule:
    - cron: '22 0-23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  system-refresh:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Identity
        run: |
          git config --global user.name "ofikur"
          git config --global user.email "ofikurr@gmail.com"

      - name: Update System Log
        env:
          TZ: 'Asia/Jakarta'
        run: |
          DATE=$(date '+%Y-%m-%d')
          TIME=$(date '+%H:%M:%S')
          TOTAL=$(git rev-list --count HEAD)
          SEQ=$((TOTAL + 1))
          
          DAILY=$(git log --since="midnight" --author="ofikurr@gmail.com" --oneline | wc -l | xargs)
          CURRENT=$((DAILY + 1))

          echo "+------------------------------------------------------+" > SYSTEM.log
          echo "|               SYSTEM AUTOMATED LOG                   |" >> SYSTEM.log
          echo "+------------------------------------------------------+" >> SYSTEM.log
          echo "|  DATE : $DATE           TIME : $TIME         |" >> SYSTEM.log
          echo "|  USER : OFIKUR               ROLE : FRONTEND_DEV     |" >> SYSTEM.log
          echo "|  DAILY: $CURRENT / 48               TOTAL: #$SEQ             |" >> SYSTEM.log
          echo "+------------------------------------------------------+" >> SYSTEM.log
          echo "|                                                      |" >> SYSTEM.log
          echo "|  > [SCAN]    Calculating History......... [DONE]     |" >> SYSTEM.log
          echo "|  > [CALC]    Daily Iteration............. [$CURRENT]       |" >> SYSTEM.log
          echo "|  > [SYNC]    Updating Database........... [OK]       |" >> SYSTEM.log
          echo "|  > [SAVE]    System Checkpoint........... [SAVED]    |" >> SYSTEM.log
          echo "|                                                      |" >> SYSTEM.log
          echo "+------------------------------------------------------+" >> SYSTEM.log
          echo "|  STATUS: ACTIVE  |  ERRORS: 0  |  MEMORY: STABLE     |" >> SYSTEM.log
          echo "+------------------------------------------------------+" >> SYSTEM.log

          git add SYSTEM.log
          git commit -m "[LOG AUTO] System Refresh: $(date '+%Y-%m-%d %H:%M') WIB"

      - name: Update Status File
        env:
          TZ: 'Asia/Jakarta'
        run: |
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          echo "CURRENT STATUS: ACTIVE" > STATUS.log
          echo "LAST CHECK: $DATE WIB" >> STATUS.log
          echo "SYSTEM: GREEN" >> STATUS.log
          
          git add STATUS.log
          git commit -m "Update Status: Active [$DATE WIB]"

      - name: Push Changes

        run: git push
